<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Parquet | lumotheninja</title>
<meta name="keywords" content="Parquet">
<meta name="description" content="My notes about Apache Parquet">
<meta name="author" content="Wen Tat">
<link rel="canonical" href="http://localhost:1313/posts/data-format/parquet/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/data-format/parquet/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Parquet" />
<meta property="og:description" content="My notes about Apache Parquet" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/data-format/parquet/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-28T00:00:00+00:00" /><meta property="og:site_name" content="Lumotheninja&#39;s blog" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Parquet"/>
<meta name="twitter:description" content="My notes about Apache Parquet"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Parquet",
      "item": "http://localhost:1313/posts/data-format/parquet/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Parquet",
  "name": "Parquet",
  "description": "My notes about Apache Parquet",
  "keywords": [
    "Parquet"
  ],
  "articleBody": "Introduction Apache Parquet is a free and open-source column-oriented data storage format in the Apache Hadoop ecosystem. It is a top level project of Apache and widely used in big data processing. There is a sister project of Parquet called Apache Arrow, which is in memory, but they can be converted vice-versa.\nIn reality, parquet refers to a type of flooring pattern, which lays the pieces of wood in horizontal and vertical patterns, the reasoning behind the name will soon become clear.\nMotivations behind parquet: There is the human readable JSON, XML/HTML, YAML or CSV/TSV format, but these formats are not efficient as they are stored as text which takes up a lot of bytes (even boolean values like true will be stored as 4 characters). The better formats will be the ones in binary such as protobuf or specialized binary files as the data can be stored in their native datatypes and definitions can be separated from the data. For binary data formats like MySQL files or protobuf files, we can do better by storing the data in a columnar format such as ORC and Parquet, so that analytics SQL can read the related data faster as well as enable better compression. for ORC vs Parquet, their design is roughly similar, but Parquet is better supported and optimized for SPARK engine while ORC is created for Hive\nParquet in theory What is inside a parquet file File A single file of the dataset, such as compact-06999-8c7e5bc0-fa44-4ba6-b273-1c13f811665a.c000.zstd.parquet A file has many rowgroups, and also has a footer which records metadata information The file is usually compressed with an algorithm such as zstd, snappy, gzip etc. Rowgroup A chunk of bytes which has many column chunks (one for each columns) for a subset of rows Column chunk A chunk of bytes which contains the data for a particular column for a subset of rows It may split the column into further smaller chunks called pages depending on the size of the column, e.g bigger columns may have more pages Page A page contains a group of rows Page row Each row in page contains the definition level, repetition level of this row as well as its value The value can be encoded in different type of encodings, such as dictionary, plain encoding, hybrid encoding etc. Dremel encoding method - the 1st layer Reference: Dremel made simple with Parquet (twitter.com) Parquet internally uses the dremel encoding method, which describes a way to store nested and repeated data in a flattened structure using repetition levels and definition levels. You can think of repetition levels and definition levels as GPS coordinates that can describe each element’s position perfectly. Lets take a fake rule engine data as an example: record 1 [ { “strategy_id”: 1000066, “rules”: [ { “rule_id”: 1, }, { “rule_id”: 2, } ] }, { “strategy_id”: 1000067 }, { “strategy_id”: 1000069, “rules”: [] }, { “strategy_id”: 1000070, “rules”: [{}] }, ] record 2 []\nrecord 3 null\nIn Parquet, the schema will be encoded as below message strategies { \u003c– definition level 0, repetition level 0 repeated group list { \u003c– repetition level 1 optional group element { \u003c– definition level 1 optional int32 strategy_id; \u003c– definition level 2 optional group rules (LIST) { \u003c– definition level 3 repeated group list { \u003c– repetition level 2 optional group element { \u003c– definition level 4 optional int rule_id; \u003c– definition level 5 } } } } } }\nSo for column strategies.element.rules.element.rule_id, it has max_definition_level of 5 and max_repetition_level of 2\nstruct value repetition level definition level explanation Record 1 { “strategy_id”: 1000066, “rules”: [ { “rule_id”: 1, }, { “rule_id”: 2, } ] }, 1 0 5 rule_id is defined, and this is the first value of the record, so we make it repetition level 0 { “strategy_id”: 1000067, “rules”: [ { “rule_id”: 1, }, { “rule_id”: 2, } ] }, 2 2 5 rule_id is defined, and this is inserted into 2nd repetition level { “strategy_id”: 1000069, “rules”: null }, null 1 1 rule id is null, and the max defined level is the element of the strategies list, which is definition level 1 { “strategy_id”: 1000070, “rules”: [] }, null 1 3\n\"strategy_id\": 1000072, \"rules\": [{\"rule_id\": null}] }, null 1 4\nNote: Under the Dremel encoding, we only store the values which has definition level = max definition level, the grey out values are not recorded but shown for clarity Dremel encoding is a shred and assembly algorithm, we can not only break down but reassemble the records with Dremel. Column encoding methods - the 2nd layer Reference: Encodings | Apache Parquet As you can see with the layout of a single parquet file - the repetition levels are written together, definition levels are written together, and finally values are written together. This means that we can use some encoding methods to store the values efficiently. Here we discuss some common encodings Plain - we just store the plain values [ Apple,apple,boy,boy,donkey,apple ]\nBitpack/run length encoding The actual bitpack/rle algorithm is kind of complicated so we will just summarize the main idea of bitpack and run length Bitpack - means how many bits can represent a number. For example, digits up to 6, we can use 3 bits to represent them, instead of 32 bits for an integer\nRunlength - means we encode values that are back to back into 2 values, the actual value and the repetition times, for example plain: [ apple,apple,boy,boy,donkey,apple ] rle: [ apple2,boy2,donkey1,apple1 ]\nDictionary encoding - there are 2 variants, plain dictionary and rle dictionary plain dictionary, this is mostly deprecated. we create a dictionary page and store the distinct values, then store the index of the dictionary value in the data pages rle dictionary, this is the default in parquet 2.0, we further encode dictionary with rle/bitpack Fallback - when the dictionary for encoding gets too big, Parquet just gives up using dictionary and starts writing the values using plain. So the dictionary space is preallocated and cannot grow.\nDelta encoding - instead of encoding the values plainly, we encode the delta between this value and the next, this is mostly used for values that increase sequentially after being clustered\nByte split stream - the idea of byte split stream is to put the bytes into buckets based on the sequence, this may greatly improve compression later Before: ELEMENT 0 ELEMENT 1 ELEMENT 3 Bytes AA BB CC DD 00 11 22 33 A3 B4 C5 D6 After: Bytes AA 00 A3 BB 11 B4 CC 22 C5 DD 33 D6 How does parquet choose which encoding to use, well it makes the decision based on some statistics of the data as well as the datatype. You can check the full logic here: parquet-mr/Encoding.java at master · apache/parquet-mr (github.com) Compression methods - the 3rd layer The above encoding methods merely applies to the column having the same value and datatype. However the file itself may still have room for compression using algorithms like snappy, gzip and ZSTD. So finally the whole file is compressed again. Here we won’t elaborate more. Speeding up queries - Dictionaries, column chunk statistics \u0026 bloom filters There are some features of parquet which can help with speeding up queries: Dictionary - the presence of dictionary means we can use a dictionary probe when checking whether the parquet file has the value we want. Please note that when Fallback flag is on, we may need to read the plain values to check whether the value is present Column chunk statistics - Parquet collects basic statistics about the data at the column chunk level, which also helps with filtering min/max - min/max can be used for the database to prune the data (such as skipping the data when its not relevant, similar to skipping indices in Clickhouse and zone map in relational database numnulls - conveniently compute null counts Bloom filter - while dictionary enables exact search, the storage space is big and may cause fallback to plain. Hence, Parquet also supports bloomfilters, which are efficient probabilistic data structures which may give false positive result. Parquet in practice In practice, we can have many ways of generating parquet files, for example using CPP, Golang etc. But in practice, it is mainly used in big data, so we shall cover its uses in Spark query engine Parquet settings Parquet settings: Parquet Files - Spark 3.1.1 Documentation (apache.org) And Bloom filter settings (not found in official docs): parquet-mr/parquet-hadoop at master · apache/parquet-mr (github.com) In normal settings, Parquet default configurations should be enough for our usage. In particular, some of the settings are not open for modification such as encoding choices and logic unless you overwrite the Parquet writer. Here are some parquet settings of interest\nsetting default val description spark.sql.parquet.compression.codec snappy Compression codec to use when saving to file. This can be one of the known case-insensitive shorten names (none, uncompressed, snappy, gzip, lzo, brotli, lz4, and zstd). This will override spark.sql.parquet.compression.codec. spark.sql.parquet.aggregatePushdown false If true, aggregates will be pushed down to Parquet for optimization. Support MIN, MAX and COUNT as aggregate expression. For MIN/MAX, support boolean, integer, float and date type. For COUNT, support all data types. If statistics is missing from any Parquet file footer, exception would be thrown. only in Spark 3.2 and above parquet.bloom.filter.enabled false only in Spark 3.2 and above\nHow to write parquet files SparkSQL/PrestoSQL - we write SparkSQL/PrestoSQL into a table, it will generate many files with a compression method like ZSTD or Snappy, the number of files generated depends on the number of partitions in the final step, in Spark you can control this by repartitioning in the final round or using some config to control create table xxx ( field1 string, field2 string ) stored as parquet\ninsert into xxx select * from yyy\nWriting directly #Pyspark df.write.format(“parquet”).save(\"./wttest2/date=2022-04-09\")\nHow to read parquet files SparkSQL/PrestoSQL - Build a external table on top of the directory of parquet files and set the table data type as Parquet, it will read the underlying Parquet file and perform schema reconcilliation (match the parquet schema with Hive schema) create table xxx ( field1 string, field2 string ) stored as parquet\nRead the files directly in Spark #Pyspark df = spark.read.parquet(‘xxxxx.zstd.parquet’)\nHow to analyse parquet files Parquet CLI: parquet-mr/parquet-cli at master · apache/parquet-mr (github.com) Using Parquet CLI, we can check the metadata of a parquet file and get a result such as this: File path: /Users/wentat.woong/compact-06999-8c7e5bc0-fa44-4ba6-b273-1c13f811665a.c000.zstd.parquet\nCreated by: parquet-mr version 1.10.1 (build a89df8f9932b6ef6633d06069e50c9b7970bebd1) Properties: org.apache.spark.version: 3.1.2 org.apache.spark.sql.parquet.row.metadata: {\"type\":\"struct\",\"fields\":[{\"name\":\"request_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"event_timestamp\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"user_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"shopee_df_plain\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"client_ip\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ip_country\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"domain_country\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"referer\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"user_agent\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"platform_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"client_url\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"attributes\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"hit_strategy_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"action_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"error_code\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"response_extra_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"event_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"event_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"source_system_name\",\"type\":\"string\",\"nullable\":false,\"metadata\":{}},{\"name\":\"event_local_datetime\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"event_regional_datetime\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"load_datetime\",\"type\":\"string\",\"nullable\":false,\"metadata\":{}},{\"name\":\"is_strategy_hit\",\"type\":\"integer\",\"nullable\":false,\"metadata\":{}},{\"name\":\"platform_desc\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"action_type_desc\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"is_ip_proxy\",\"type\":\"boolean\",\"nullable\":true,\"metadata\":{}},{\"name\":\"cookie\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"cookie_length\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ip_type_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tls_fp_type_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tls_fp_md5_hash\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"hit_strategy_info_v2\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"waf_event_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tss_hit_module\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tss_hit_module_desc\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"domain\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"api_path\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"http_method\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"content_length\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ua_type_id\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}},{\"name\":\"device_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tls_fp\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"request_header\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"request_body\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"session_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"sap\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"encrypted_security_data\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"dfp_token\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ac_hit_strategy_ids\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"query\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"query_pair\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"hit_strategy_ids\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"ip_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"android_sdk_env_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ios_sdk_env_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"web_sdk_env_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"client_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"is_support_captcha\",\"type\":\"boolean\",\"nullable\":true,\"metadata\":{}},{\"name\":\"experimental_event_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"experimental_waf_event_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"experimental_hit_strategy_info\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tss_experimental_hit_module\",\"type\":\"integer\",\"nullable\":true,\"metadata\":{}}]} Schema: message spark_schema { optional binary request_id (STRING); optional int64 event_timestamp; optional int64 user_id; optional binary shopee_df_plain (STRING); optional binary client_ip (STRING); optional binary ip_country (STRING); optional binary domain_country (STRING); optional binary referer (STRING); optional binary user_agent (STRING); optional int32 platform_id; optional binary client_url (STRING); optional binary attributes (STRING); optional binary hit_strategy_info (STRING); optional int32 action_id; optional int32 error_code; optional binary response_extra_info (STRING); optional int32 event_id; optional binary event_name (STRING); required binary source_system_name (STRING); optional binary event_local_datetime (STRING); optional binary event_regional_datetime (STRING); required binary load_datetime (STRING); required int32 is_strategy_hit; optional binary platform_desc (STRING); optional binary action_type_desc (STRING); optional boolean is_ip_proxy; optional binary cookie (STRING); optional int32 cookie_length; optional int32 ip_type_id; optional int32 tls_fp_type_id; optional binary tls_fp_md5_hash (STRING); optional binary hit_strategy_info_v2 (STRING); optional int64 waf_event_id; optional int32 tss_hit_module; optional binary tss_hit_module_desc (STRING); optional binary domain (STRING); optional binary api_path (STRING); optional binary http_method (STRING); optional binary content_length (STRING); optional int32 ua_type_id; optional binary device_id (STRING); optional binary tls_fp (STRING); optional binary request_header (STRING); optional binary request_body (STRING); optional binary session_id (STRING); optional binary sap (STRING); optional binary encrypted_security_data (STRING); optional binary dfp_token (STRING); optional binary ac_hit_strategy_ids (STRING); optional binary query (STRING); optional binary query_pair (STRING); optional group hit_strategy_ids (LIST) { repeated group list { optional int64 element; } } optional binary ip_info (STRING); optional binary android_sdk_env_info (STRING); optional binary ios_sdk_env_info (STRING); optional binary web_sdk_env_info (STRING); optional binary client_id (STRING); optional boolean is_support_captcha; optional int64 experimental_event_id; optional int64 experimental_waf_event_id; optional binary experimental_hit_strategy_info (STRING); optional int32 tss_experimental_hit_module; } Row group 0: count: 98787 1.127 kB records start: 4 total(compressed): 108.725 MB total(uncompressed):108.725 MB -------------------------------------------------------------------------------- type encodings count avg size nulls min / max request_id BINARY Z _ 98787 20.57 B 0 \"00025f52-f592-427f-ac65-c...\" / \"ffffe14e-a3da-4596-9996-f...\" event_timestamp INT64 Z _ R 98787 3.41 B 0 \"1679414400\" / \"1679500791\" user_id INT64 Z _ 98787 0.78 B 84129 \"10033\" / \"1200175406\" shopee_df_plain BINARY Z _ R 98787 5.37 B 73579 \"\" / \"zykwsyB2z5LWFg7hDqJcJV6GR...\" client_ip BINARY Z _ R 98787 2.93 B 0 \"1.0.239.175\" / \"99.39.155.249\" ip_country BINARY Z _ R 98787 0.46 B 0 \"\" / \"ZA\" domain_country BINARY Z _ R 98787 0.00 B 0 \"SG\" / \"SG\" referer BINARY Z _ R_ F 98787 12.10 B 0 \"\" / \"top1sg\" user_agent BINARY Z _ R_ F 98787 4.14 B 0 \"\" / \"unirest-php/2.0\" platform_id INT32 Z _ R 98787 0.27 B 0 \"0\" / \"8\" client_url BINARY Z _ R_ F 98787 51.06 B 0 \"http://c-api-subaccount.s...\" / \"https://wfm.ssc.shopee.co...\" attributes BINARY Z _ 98787 644.20 B hit_strategy_info BINARY Z _ 98787 0.00 B action_id INT32 Z _ R 98787 0.05 B 0 \"0\" / \"5\" error_code INT32 Z _ R 98787 0.00 B 0 \"0\" / \"0\" response_extra_info BINARY Z _ R 98787 0.04 B 0 \"{\"challenge_type\":1,\"capt...\" / \"{}\" event_id INT32 Z _ R 98787 0.27 B 0 \"0\" / \"9714\" event_name BINARY Z _ R 98787 0.08 B 93108 \"discovery_landing\" / \"search_event\" source_system_name BINARY Z _ R 98787 0.00 B 0 \"anti_crawler\" / \"anti_crawler\" event_local_datetime BINARY Z _ R_ F 98787 4.18 B 0 \"2023-03-22 00:00:00\" / \"2023-03-22 23:59:51\" event_regional_datetime BINARY Z _ R_ F 98787 4.18 B 0 \"2023-03-22 00:00:00\" / \"2023-03-22 23:59:51\" load_datetime BINARY Z _ R 98787 0.00 B 0 \"2023-03-23 02:02:35.237\" / \"2023-03-23 02:02:35.237\" is_strategy_hit INT32 Z _ R 98787 0.07 B 0 \"0\" / \"1\" platform_desc BINARY Z _ R 98787 0.27 B 0 \"android_app\" / \"unknown\" action_type_desc BINARY Z _ R 98787 0.05 B 616 \"allow\" / \"force_login\" is_ip_proxy BOOLEAN Z _ 98787 0.09 B 89739 \"false\" / \"true\" cookie BINARY Z _ R_ F 98787 93.63 B 0 \"\" / \"{}\" cookie_length INT32 Z _ R 98787 0.67 B 0 \"0\" / \"4305\" ip_type_id INT32 Z _ R 98787 0.03 B 0 \"0\" / \"2\" tls_fp_type_id INT32 Z _ R 98787 0.22 B 0 \"0\" / \"5\" tls_fp_md5_hash BINARY Z _ R 98787 1.79 B 0 \"\" / \"fffcc29122e024fe3cb419afc...\" hit_strategy_info_v2 BINARY Z _ R_ F 98787 2.01 B 0 \"[]\" / \"[{\"strategy_id\":971400000...\" waf_event_id INT64 Z _ R 98787 0.20 B 0 \"0\" / \"9716\" tss_hit_module INT32 Z _ R 98787 0.06 B 0 \"0\" / \"3\" tss_hit_module_desc BINARY Z _ R 98787 0.06 B 0 \"anti_crawler\" / \"waf\" domain BINARY Z _ R 98787 0.31 B 0 \"ats.workatsea.com\" / \"wfm.ssc.shopee.com\" api_path BINARY Z _ R 98787 1.34 B 0 \"/\" / \"/zenkosuperfoods\" http_method BINARY Z _ R 98787 0.18 B 0 \"GET\" / \"PUT\" content_length BINARY Z _ 98787 0.00 B ua_type_id INT32 Z _ 98787 0.00 B 98787 device_id BINARY Z _ R 98787 0.24 B 96651 \"1399998037467459258\" / \"4444444444444444444\" tls_fp BINARY Z _ R 98787 2.12 B 0 \"\" / \"771,61-53-49192-49191-491...\" request_header BINARY Z _ R_ F 98787 80.99 B 0 \"{\"1\":\"Content-Type:applic...\" / \"{\"x-whs-id\":\"TWYW\",\"accep...\" request_body BINARY Z _ R_ F 98787 31.43 B 0 \"\" / \"{}\" session_id BINARY Z _ 98787 0.00 B sap BINARY Z _ R_ F 98787 9.67 B 0 \"{\"method\":\"GET\",\"region\":...\" / \"{\"signature\":\"zpyBEkC0Q5-...\" encrypted_security_data BINARY Z _ R_ F 98787 26.68 B 83402 \"\" / \"y\" dfp_token BINARY Z _ 98787 0.00 B ac_hit_strategy_ids BINARY Z _ R 98787 1.42 B 0 \"GET_ats.workatsea.com_/at...\" / \"PUT_help.shopee.sg_/api/i...\" query BINARY Z _ R_ F 98787 45.23 B 0 \"\" / \"zarsrc=31\u0026utm_source=zalo...\" query_pair BINARY Z _ R_ F 98787 48.70 B 0 \"{\"CSRF_TOKEN\":\"b910ca37-e...\" / \"{}\" hit_strategy_ids.list.element INT64 Z _ R 110597 0.25 B 92280 \"7000\" / \"97140000003\" ip_info BINARY Z _ 98787 35.50 B 0 \"{\"asn\":\"-\",\"city\":\"-\",\"is...\" / \"{\"usagetype\":\"SES\",\"threa...\" android_sdk_env_info BINARY Z _ 98787 8.25 B 93520 \"{\"android_checksum_check\"...\" / \"{\"wifi_ssid\":\"\\\"rayerayeo...\" ios_sdk_env_info BINARY Z _ 98787 3.71 B 95001 \"{\"api_hooked_info\":\"\",\"ba...\" / \"{\"wifi_ssid\":\"\",\"wifi_ip_...\" web_sdk_env_info BINARY Z _ R_ F 98787 4.63 B 96057 \"{\"audio_index\":\"\",\"beauti...\" / \"{\"window_top_position\":84...\" client_id BINARY Z _ R 98787 0.06 B 93975 \"\" / \"\" is_support_captcha BOOLEAN Z _ 98787 0.08 B 92209 \"false\" / \"true\" experimental_event_id INT64 Z _ R 98787 0.00 B 0 \"0\" / \"0\" experimental_waf_event_id INT64 Z _ R 98787 0.00 B 0 \"0\" / \"0\" experimental_hit_strategy_info BINARY Z _ R 98787 0.00 B 0 \"[]\" / \"[]\" tss_experimental_hit_module INT32 Z _ 98787 0.00 B 98787 Row group 1: count: 95636 1.078 kB records start: 114006788 total(compressed): 100.690 MB total(uncompressed):100.690 MB -------------------------------------------------------------------------------- type encodings count avg size nulls min / max request_id BINARY Z _ 95636 20.58 B 0 \"0002b378-c388-42bd-acd2-9...\" / \"fffc9037-04d4-4da6-890c-3...\" event_timestamp INT64 Z _ R 95636 3.37 B 0 \"1679414401\" / \"1679500798\" user_id INT64 Z _ 95636 0.67 B 83711 \"11742\" / \"973157000\" shopee_df_plain BINARY Z _ R 95636 4.72 B 74195 \"\" / \"zzgSI7P7xIljQVmv2JAR7B03a...\" client_ip BINARY Z _ R 95636 2.82 B 0 \"1.10.202.98\" / \"99.246.22.202\" ip_country BINARY Z _ R 95636 0.45 B 0 \"\" / \"ZA\" domain_country BINARY Z _ R 95636 0.00 B 0 \"SG\" / \"SG\" referer BINARY Z _ R_ F 95636 12.25 B 0 \"\" / \"https://zimpolo.com/\" user_agent BINARY Z _ R_ F 95636 3.96 B 0 \"\" / \"unirest-php/2.0\" platform_id INT32 Z _ R 95636 0.27 B 0 \"0\" / \"8\" client_url BINARY Z _ R_ F 95636 52.20 B 0 \"http://c-api-subaccount.s...\" / \"https://wfm.ssc.shopee.co...\" attributes BINARY Z _ 95636 617.98 B hit_strategy_info BINARY Z _ 95636 0.00 B action_id INT32 Z _ R 95636 0.05 B 0 \"0\" / \"5\" error_code INT32 Z _ R 95636 0.00 B 0 \"0\" / \"0\" response_extra_info BINARY Z _ R 95636 0.04 B 0 \"{\"challenge_type\":1,\"capt...\" / \"{}\" event_id INT32 Z _ R 95636 0.26 B 0 \"0\" / \"9714\" event_name BINARY Z _ R 95636 0.08 B 90601 \"discovery_landing\" / \"spx_event\" source_system_name BINARY Z _ R 95636 0.00 B 0 \"anti_crawler\" / \"anti_crawler\" event_local_datetime BINARY Z _ R_ F 95636 4.10 B 0 \"2023-03-22 00:00:01\" / \"2023-03-22 23:59:58\" event_regional_datetime BINARY Z _ R_ F 95636 4.10 B 0 \"2023-03-22 00:00:01\" / \"2023-03-22 23:59:58\" load_datetime BINARY Z _ R 95636 0.00 B 0 \"2023-03-23 02:02:35.237\" / \"2023-03-23 02:02:35.237\" is_strategy_hit INT32 Z _ R 95636 0.07 B 0 \"0\" / \"1\" platform_desc BINARY Z _ R 95636 0.27 B 0 \"android_app\" / \"unknown\" action_type_desc BINARY Z _ R 95636 0.05 B 560 \"allow\" / \"force_login\" is_ip_proxy BOOLEAN Z _ 95636 0.08 B 88200 \"false\" / \"true\" cookie BINARY Z _ R_ F 95636 79.81 B 0 \"\" / \"{}\" cookie_length INT32 Z _ R 95636 0.63 B 0 \"0\" / \"3688\" ip_type_id INT32 Z _ R 95636 0.03 B 0 \"0\" / \"2\" tls_fp_type_id INT32 Z _ R 95636 0.23 B 0 \"0\" / \"5\" tls_fp_md5_hash BINARY Z _ R 95636 1.70 B 0 \"\" / \"fffd2ec209e0d89e606cbb061...\" hit_strategy_info_v2 BINARY Z _ R_ F 95636 1.93 B 0 \"[]\" / \"[{\"strategy_id\":971400000...\" waf_event_id INT64 Z _ R 95636 0.20 B 0 \"0\" / \"9716\" tss_hit_module INT32 Z _ R 95636 0.06 B 0 \"0\" / \"3\" tss_hit_module_desc BINARY Z _ R 95636 0.06 B 0 \"anti_crawler\" / \"waf\" domain BINARY Z _ R 95636 0.29 B 0 \"ats.workatsea.com\" / \"wfm.ssc.shopee.com\" api_path BINARY Z _ R 95636 1.33 B 0 \"/\" / \"/zenkosuperfoods\" http_method BINARY Z _ R 95636 0.18 B 0 \"GET\" / \"PUT\" content_length BINARY Z _ 95636 0.00 B ua_type_id INT32 Z _ 95636 0.00 B 95636 device_id BINARY Z _ R 95636 0.21 B 93875 \"1399683719822439175\" / \"1638570858845819429\" tls_fp BINARY Z _ R 95636 2.05 B 0 \"\" / \"771,61-53-49192-49191-491...\" request_header BINARY Z _ R_ F 95636 76.18 B 0 \"{\"0\":\"Accept:*/*\",\"host\":...\" / \"{\"x-whs-id\":\"TWYW\",\"conte...\" request_body BINARY Z _ R_ F 95636 30.45 B 0 \"\" / \"{}\" session_id BINARY Z _ 95636 0.00 B sap BINARY Z _ R_ F 95636 8.72 B 0 \"{\"method\":\"GET\",\"region\":...\" / \"{\"signature\":\"zxkNMfBsS28...\" encrypted_security_data BINARY Z _ R_ F 95636 22.94 B 82594 \"\" / \"z\" dfp_token BINARY Z _ 95636 0.00 B ac_hit_strategy_ids BINARY Z _ R 95636 1.40 B 0 \"GET_ats.workatsea.com_/at...\" / \"PUT_help.shopee.sg_/api/i...\" query BINARY Z _ R_ F 95636 46.50 B 0 \"\" / \"zarsrc=31\u0026utm_source=zalo...\" query_pair BINARY Z _ R_ F 95636 49.92 B 0 \"{\"CSRF_TOKEN\":\"47f3be6f-4...\" / \"{}\" hit_strategy_ids.list.element INT64 Z _ R 106654 0.24 B 89741 \"7000\" / \"97140000003\" ip_info BINARY Z _ 95636 35.36 B 0 \"{\"asn\":\"-\",\"city\":\"-\",\"do...\" / \"{\"usagetype\":\"SES\",\"threa...\" android_sdk_env_info BINARY Z _ 95636 7.02 B 91310 \"{\"android_checksum_check\"...\" / \"{\"wifi_ssid\":\"\\\"winter so...\" ios_sdk_env_info BINARY Z _ 95636 3.22 B 92519 \"{\"api_hooked_info\":\"\",\"ba...\" / \"{\"wifi_ssid\":\"\",\"wifi_ip_...\" web_sdk_env_info BINARY Z _ R_ F 95636 4.76 B 92982 \"{\"audio_index\":\"\",\"batter...\" / \"{\"window_top_position\":84...\" client_id BINARY Z _ R 95636 0.06 B 91471 \"\" / \"\" is_support_captcha BOOLEAN Z _ 95636 0.08 B 89801 \"false\" / \"true\" experimental_event_id INT64 Z _ R 95636 0.00 B 0 \"0\" / \"0\" experimental_waf_event_id INT64 Z _ R 95636 0.00 B 0 \"0\" / \"0\" experimental_hit_strategy_info BINARY Z _ R 95636 0.00 B 0 \"[]\" / \"[]\" tss_experimental_hit_module INT32 Z _ 95636 0.00 B 95636 Encodings ([_SGLB$Z?])\\s([RD?\\s])?\\s(R)?()?(D)?(\\sF)?\nFirst group, compression codec _ = uncompressed S = snappy G = gzip L = LZ0 B = Brotli 4 = LZ4 Z = ZSTD ? = unknown Second group, enum of dictionary encoding _ = plain R= RLE D = delta byte array ? = unknown \\s = no dictionary Third group, whether encodings has RLE R = data encodings has RLE Forth group, whether data encodings has plain _ = data encodings has plain Fifth group, whether data encodings has delta D = data encodings has delta Sixth group, whether data has fallback \\sF = data has fallback In our example, we can understand it as follows: Z _ = ZSTD compressed, no dictionary, data encoded in plain, example: request_id Z _ R = ZSTD compressed, data encoded in plain dictionary, but data is RLE example: event_timestamp Z _ R_ F = ZSTD compressed, dictionary encoded in plain, data encoded in RLE and plain, there is a fallback, example: referer, user_agent Key takeaways Theory - theory of parquet is useful not just for knowledge’s sake but is widely used in systems such as Spark, Hudi and Flink. Even new data formats such as delta and arrow are inspired by parquet. Understanding parquet helps to understand the more complicated systems and data formats, and hopefully lets you design better systems Query - parquet stores the columns separately, so by querying only columns we need, we can speed up the queries by only reading the related column chunks Schema design - if you map the schema directly to parquet types, you can save the key for space and also use more efficient data types and encodings. So its definitely more space efficient to store the schema as detailed as it can be, instead of using a big string JSON field for example Data colocation - due to the RLE/bitpack encoding method used in parquet, if we skew the data, we can efficiently store it. So if we put the same data in the same parquet file, we can save a lot of storage space, in fact, there is an ongoing effort by our team to improve the storage space usage using this method\n",
  "wordCount" : "3868",
  "inLanguage": "en",
  "datePublished": "2024-04-28T00:00:00Z",
  "dateModified": "2024-04-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Wen Tat"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/data-format/parquet/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "lumotheninja",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Lumotheninja (Alt + H)">
                <img src="http://localhost:1313/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Lumotheninja</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Parquet
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-description">
      My notes about Apache Parquet
    </div>
    <div class="post-meta"><span title='2024-04-28 00:00:00 +0000 UTC'>April 28, 2024</span>&nbsp;·&nbsp;19 min&nbsp;·&nbsp;3868 words&nbsp;·&nbsp;Wen Tat

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#motivations-behind-parquet">Motivations behind parquet:</a></li>
    <li><a href="#parquet-in-theory">Parquet in theory</a>
      <ul>
        <li><a href="#what-is-inside-a-parquet-file">What is inside a parquet file</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>Apache Parquet is a free and open-source column-oriented data storage format in the Apache Hadoop ecosystem. It is a top level project of Apache and widely used in big data processing. There is a sister project of Parquet called Apache Arrow, which is in memory, but they can be converted vice-versa.</p>
<p>In reality, parquet refers to a type of flooring pattern, which lays the pieces of wood in horizontal and vertical patterns, the reasoning behind the name will soon become clear.</p>
<h2 id="motivations-behind-parquet">Motivations behind parquet:<a hidden class="anchor" aria-hidden="true" href="#motivations-behind-parquet">#</a></h2>
<p>There is the human readable JSON, XML/HTML, YAML or CSV/TSV format, but these formats are not efficient as they are stored as text which takes up a lot of bytes (even boolean values like true will be stored as 4 characters). The better formats will be the ones in binary such as protobuf or specialized binary files as the data can be stored in their native datatypes and definitions can be separated from the data.
For binary data formats like MySQL files or protobuf files, we can do better by storing the data in a columnar format such as ORC and Parquet, so that analytics SQL can read the related data faster as well as enable better compression.
for ORC vs Parquet, their design is roughly similar, but Parquet is better supported and optimized for SPARK engine while ORC is created for Hive</p>
<h2 id="parquet-in-theory">Parquet in theory<a hidden class="anchor" aria-hidden="true" href="#parquet-in-theory">#</a></h2>
<h3 id="what-is-inside-a-parquet-file">What is inside a parquet file<a hidden class="anchor" aria-hidden="true" href="#what-is-inside-a-parquet-file">#</a></h3>
<ol>
<li>File
A single file of the dataset, such as compact-06999-8c7e5bc0-fa44-4ba6-b273-1c13f811665a.c000.zstd.parquet
A file has many rowgroups, and also has a footer which records metadata information
The file is usually compressed with an algorithm such as zstd, snappy, gzip etc.
Rowgroup
A chunk of bytes which has many column chunks (one for each columns) for a subset of rows
Column chunk
A chunk of bytes which contains the data for a particular column for a subset of rows
It may split the column into further smaller chunks called pages depending on the size of the column, e.g bigger columns may have more pages
Page
A page contains a group of rows
Page row
Each row in page contains the definition level, repetition level of this row as well as its value
The value can be encoded in different type of encodings, such as dictionary, plain encoding, hybrid encoding etc.
Dremel encoding method - the 1st layer
Reference: Dremel made simple with Parquet (twitter.com)
Parquet internally uses the dremel encoding method, which describes a way to store nested and repeated data in a flattened structure using repetition levels and definition levels. You can think of repetition levels and definition levels as GPS coordinates that can describe each element&rsquo;s position perfectly. Lets take a fake rule engine data as an example:
record 1
[
{
&ldquo;strategy_id&rdquo;: 1000066,
&ldquo;rules&rdquo;: [
{
&ldquo;rule_id&rdquo;: 1,
},
{
&ldquo;rule_id&rdquo;: 2,
}
]
},
{
&ldquo;strategy_id&rdquo;: 1000067
},
{
&ldquo;strategy_id&rdquo;: 1000069,
&ldquo;rules&rdquo;: []
},
{
&ldquo;strategy_id&rdquo;: 1000070,
&ldquo;rules&rdquo;: [{}]
},
]</li>
</ol>
<p>record 2
[]</p>
<p>record 3
null</p>
<p>In Parquet, the schema will be encoded as below
message strategies { &lt;&ndash; definition level 0, repetition level 0
repeated group list { &lt;&ndash; repetition level 1
optional group element { &lt;&ndash; definition level 1
optional int32 strategy_id;  &lt;&ndash; definition level 2
optional group rules (LIST) {  &lt;&ndash; definition level 3
repeated group list {   &lt;&ndash; repetition level 2
optional group element { &lt;&ndash; definition level 4
optional int rule_id; &lt;&ndash; definition level 5
}
}
}
}
}
}</p>
<p>So for column strategies.element.rules.element.rule_id, it has max_definition_level of 5 and max_repetition_level of 2</p>
<p>struct
value
repetition level
definition level
explanation
Record 1
{
&ldquo;strategy_id&rdquo;: 1000066,
&ldquo;rules&rdquo;: [
{
&ldquo;rule_id&rdquo;: 1,
},
{
&ldquo;rule_id&rdquo;: 2,
}
]
},
1
0
5
rule_id is defined, and this is the first value of the record, so we make it repetition level 0
{
&ldquo;strategy_id&rdquo;: 1000067,
&ldquo;rules&rdquo;: [
{
&ldquo;rule_id&rdquo;: 1,
},
{
&ldquo;rule_id&rdquo;: 2,
}
]
},
2
2
5
rule_id is defined, and this is inserted into 2nd repetition level
{
&ldquo;strategy_id&rdquo;: 1000069,
&ldquo;rules&rdquo;: null
},
null
1
1
rule id is null, and the max defined level is the element of the strategies list, which is definition level 1
{
&ldquo;strategy_id&rdquo;: 1000070,
&ldquo;rules&rdquo;: []
},
null
1
3</p>
<pre><code>    &quot;strategy_id&quot;: 1000072,
    &quot;rules&quot;: [{&quot;rule_id&quot;: null}]
},
</code></pre>
<p>null
1
4</p>
<p>Note:
Under the Dremel encoding, we only store the values which has definition level = max definition level, the grey out values are not recorded but shown for clarity
Dremel encoding is a shred and assembly algorithm, we can not only break down but reassemble the records with Dremel.
Column encoding methods - the 2nd layer
Reference: Encodings | Apache Parquet
As you can see with the layout of a single parquet file - the repetition levels are written together, definition levels are written together, and finally values are written together. This means that we can use some encoding methods to store the values efficiently. Here we discuss some common encodings
Plain - we just store the plain values
[ Apple,apple,boy,boy,donkey,apple ]</p>
<p>Bitpack/run length encoding
The actual bitpack/rle algorithm is kind of complicated so we will just summarize the main idea of bitpack and run length
Bitpack - means how many bits can represent a number. For example, digits up to 6, we can use 3 bits to represent them, instead of 32 bits for an integer</p>
<p>Runlength - means we encode values that are back to back into 2 values, the actual value and the repetition times, for example
plain: [ apple,apple,boy,boy,donkey,apple ]
rle: [ apple2,boy2,donkey1,apple1 ]</p>
<p>Dictionary encoding - there are 2 variants, plain dictionary and rle dictionary
plain dictionary, this is mostly deprecated. we create a dictionary page and store the distinct values, then store the index of the dictionary value in the data pages
rle dictionary, this is the default in parquet 2.0, we further encode dictionary with rle/bitpack
Fallback - when the dictionary for encoding gets too big, Parquet just gives up using dictionary and starts writing the values using plain. So the dictionary space is preallocated and cannot grow.</p>
<p>Delta encoding - instead of encoding the values plainly, we encode the delta between this value and the next, this is mostly used for values that increase sequentially after being clustered</p>
<p>Byte split stream - the idea of byte split stream is to put the bytes into buckets based on the sequence, this may greatly improve compression later
Before:
ELEMENT 0      ELEMENT 1      ELEMENT 3
Bytes  AA BB CC DD    00 11 22 33    A3 B4 C5 D6
After:
Bytes  AA 00 A3 BB 11 B4 CC 22 C5 DD 33 D6
How does parquet choose which encoding to use, well it makes the decision based on some statistics of the data as well as the datatype. You can check the full logic here:  parquet-mr/Encoding.java at master · apache/parquet-mr (github.com)
Compression methods - the 3rd layer
The above encoding methods merely applies to the column having the same value and datatype. However the file itself may still have room for compression using algorithms like snappy, gzip and ZSTD. So finally the whole file is compressed again. Here we won&rsquo;t elaborate more.
Speeding up queries - Dictionaries, column chunk statistics &amp; bloom filters
There are some features of parquet which can help with speeding up queries:
Dictionary - the presence of dictionary means we can use a dictionary probe when checking whether the parquet file has the value we want. Please note that when Fallback flag is on, we may need to read the plain values to check whether the value is present
Column chunk statistics - Parquet collects basic statistics about the data at the column chunk level, which also helps with filtering
min/max - min/max can be used for the database to prune the data (such as skipping the data when its not relevant, similar to skipping indices in Clickhouse and zone map in relational database
numnulls - conveniently compute null counts
Bloom filter - while dictionary enables exact search, the storage space is big and may cause fallback to plain. Hence, Parquet also supports bloomfilters, which are efficient probabilistic data structures which may give false positive result.
Parquet in practice
In practice, we can have many ways of generating parquet files, for example using CPP, Golang etc. But in practice, it is mainly used in big data, so we shall cover its uses in Spark query engine
Parquet settings
Parquet settings: Parquet Files - Spark 3.1.1 Documentation (apache.org)
And Bloom filter settings (not found in official docs): parquet-mr/parquet-hadoop at master · apache/parquet-mr (github.com)
In normal settings, Parquet default configurations should be enough for our usage. In particular, some of the settings are not open for modification such as encoding choices and logic unless you overwrite the Parquet writer. Here are some parquet settings of interest</p>
<p>setting
default val
description
spark.sql.parquet.compression.codec
snappy
Compression codec to use when saving to file. This can be one of the known case-insensitive shorten names (none, uncompressed, snappy, gzip, lzo, brotli, lz4, and zstd). This will override spark.sql.parquet.compression.codec.
spark.sql.parquet.aggregatePushdown
false
If true, aggregates will be pushed down to Parquet for optimization. Support MIN, MAX and COUNT as aggregate expression. For MIN/MAX, support boolean, integer, float and date type. For COUNT, support all data types. If statistics is missing from any Parquet file footer, exception would be thrown.
only in Spark 3.2 and above
parquet.bloom.filter.enabled
false
only in Spark 3.2 and above</p>
<p>How to write parquet files
SparkSQL/PrestoSQL - we write SparkSQL/PrestoSQL into a table, it will generate many files with a compression method like ZSTD or Snappy, the number of files generated depends on the number of partitions in the final step, in Spark you can control this by repartitioning in the final round or using some config to control
create table xxx (
field1 string,
field2 string
) stored as parquet</p>
<p>insert into xxx
select * from yyy</p>
<p>Writing directly
#Pyspark
df.write.format(&ldquo;parquet&rdquo;).save(&quot;./wttest2/date=2022-04-09&quot;)</p>
<p>How to read parquet files
SparkSQL/PrestoSQL - Build a  external table on top of the directory of parquet files and set the table data type as Parquet, it will read the underlying Parquet file and perform schema reconcilliation (match the parquet schema with Hive schema)
create table xxx (
field1 string,
field2 string
) stored as parquet</p>
<p>Read the files directly in Spark
#Pyspark
df = spark.read.parquet(&lsquo;xxxxx.zstd.parquet&rsquo;)</p>
<p>How to analyse parquet files
Parquet CLI: parquet-mr/parquet-cli at master · apache/parquet-mr (github.com)
Using Parquet CLI, we can check the metadata of a parquet file and get a result such as this:
File path:  /Users/wentat.woong/compact-06999-8c7e5bc0-fa44-4ba6-b273-1c13f811665a.c000.zstd.parquet</p>
<pre tabindex="0"><code>Created by: parquet-mr version 1.10.1 (build a89df8f9932b6ef6633d06069e50c9b7970bebd1)

Properties:

                   org.apache.spark.version: 3.1.2

  org.apache.spark.sql.parquet.row.metadata: {&#34;type&#34;:&#34;struct&#34;,&#34;fields&#34;:[{&#34;name&#34;:&#34;request_id&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;event_timestamp&#34;,&#34;type&#34;:&#34;long&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;user_id&#34;,&#34;type&#34;:&#34;long&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;shopee_df_plain&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;client_ip&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ip_country&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;domain_country&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;referer&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;user_agent&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;platform_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;client_url&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;attributes&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;hit_strategy_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;action_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;error_code&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;response_extra_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;event_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;event_name&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;source_system_name&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:false,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;event_local_datetime&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;event_regional_datetime&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;load_datetime&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:false,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;is_strategy_hit&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:false,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;platform_desc&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;action_type_desc&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;is_ip_proxy&#34;,&#34;type&#34;:&#34;boolean&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;cookie&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;cookie_length&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ip_type_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tls_fp_type_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tls_fp_md5_hash&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;hit_strategy_info_v2&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;waf_event_id&#34;,&#34;type&#34;:&#34;long&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tss_hit_module&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tss_hit_module_desc&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;domain&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;api_path&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;http_method&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;content_length&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ua_type_id&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;device_id&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tls_fp&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;request_header&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;request_body&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;session_id&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;sap&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;encrypted_security_data&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;dfp_token&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ac_hit_strategy_ids&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;query&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;query_pair&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;hit_strategy_ids&#34;,&#34;type&#34;:{&#34;type&#34;:&#34;array&#34;,&#34;elementType&#34;:&#34;long&#34;,&#34;containsNull&#34;:true},&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ip_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;android_sdk_env_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;ios_sdk_env_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;web_sdk_env_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;client_id&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;is_support_captcha&#34;,&#34;type&#34;:&#34;boolean&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;experimental_event_id&#34;,&#34;type&#34;:&#34;long&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;experimental_waf_event_id&#34;,&#34;type&#34;:&#34;long&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;experimental_hit_strategy_info&#34;,&#34;type&#34;:&#34;string&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}},{&#34;name&#34;:&#34;tss_experimental_hit_module&#34;,&#34;type&#34;:&#34;integer&#34;,&#34;nullable&#34;:true,&#34;metadata&#34;:{}}]}

Schema:

message spark_schema {
  optional binary request_id (STRING);
  optional int64 event_timestamp;
  optional int64 user_id;
  optional binary shopee_df_plain (STRING);
  optional binary client_ip (STRING);
  optional binary ip_country (STRING);
  optional binary domain_country (STRING);
  optional binary referer (STRING);
  optional binary user_agent (STRING);
  optional int32 platform_id;
  optional binary client_url (STRING);
  optional binary attributes (STRING);
  optional binary hit_strategy_info (STRING);
  optional int32 action_id;
  optional int32 error_code;
  optional binary response_extra_info (STRING);
  optional int32 event_id;
  optional binary event_name (STRING);
  required binary source_system_name (STRING);
  optional binary event_local_datetime (STRING);
  optional binary event_regional_datetime (STRING);
  required binary load_datetime (STRING);
  required int32 is_strategy_hit;
  optional binary platform_desc (STRING);
  optional binary action_type_desc (STRING);
  optional boolean is_ip_proxy;
  optional binary cookie (STRING);
  optional int32 cookie_length;
  optional int32 ip_type_id;
  optional int32 tls_fp_type_id;
  optional binary tls_fp_md5_hash (STRING);
  optional binary hit_strategy_info_v2 (STRING);
  optional int64 waf_event_id;
  optional int32 tss_hit_module;
  optional binary tss_hit_module_desc (STRING);
  optional binary domain (STRING);
  optional binary api_path (STRING);
  optional binary http_method (STRING);
  optional binary content_length (STRING);
  optional int32 ua_type_id;
  optional binary device_id (STRING);
  optional binary tls_fp (STRING);
  optional binary request_header (STRING);
  optional binary request_body (STRING);
  optional binary session_id (STRING);
  optional binary sap (STRING);
  optional binary encrypted_security_data (STRING);
  optional binary dfp_token (STRING);
  optional binary ac_hit_strategy_ids (STRING);
  optional binary query (STRING);
  optional binary query_pair (STRING);
  optional group hit_strategy_ids (LIST) {
    repeated group list {
      optional int64 element;
    }
  }
  optional binary ip_info (STRING);
  optional binary android_sdk_env_info (STRING);
  optional binary ios_sdk_env_info (STRING);
  optional binary web_sdk_env_info (STRING);
  optional binary client_id (STRING);
  optional boolean is_support_captcha;
  optional int64 experimental_event_id;
  optional int64 experimental_waf_event_id;
  optional binary experimental_hit_strategy_info (STRING);
  optional int32 tss_experimental_hit_module;
}

Row group 0:  count: 98787  1.127 kB records  start: 4  total(compressed): 108.725 MB total(uncompressed):108.725 MB 

--------------------------------------------------------------------------------

                                type      encodings count     avg size   nulls   min / max

request_id                      BINARY    Z   _     98787     20.57 B    0       &#34;00025f52-f592-427f-ac65-c...&#34; / &#34;ffffe14e-a3da-4596-9996-f...&#34;

event_timestamp                 INT64     Z _ R     98787     3.41 B     0       &#34;1679414400&#34; / &#34;1679500791&#34;

user_id                         INT64     Z   _     98787     0.78 B     84129   &#34;10033&#34; / &#34;1200175406&#34;

shopee_df_plain                 BINARY    Z _ R     98787     5.37 B     73579   &#34;&#34; / &#34;zykwsyB2z5LWFg7hDqJcJV6GR...&#34;

client_ip                       BINARY    Z _ R     98787     2.93 B     0       &#34;1.0.239.175&#34; / &#34;99.39.155.249&#34;

ip_country                      BINARY    Z _ R     98787     0.46 B     0       &#34;&#34; / &#34;ZA&#34;

domain_country                  BINARY    Z _ R     98787     0.00 B     0       &#34;SG&#34; / &#34;SG&#34;

referer                         BINARY    Z _ R_ F  98787     12.10 B    0       &#34;&#34; / &#34;top1sg&#34;

user_agent                      BINARY    Z _ R_ F  98787     4.14 B     0       &#34;&#34; / &#34;unirest-php/2.0&#34;

platform_id                     INT32     Z _ R     98787     0.27 B     0       &#34;0&#34; / &#34;8&#34;

client_url                      BINARY    Z _ R_ F  98787     51.06 B    0       &#34;http://c-api-subaccount.s...&#34; / &#34;https://wfm.ssc.shopee.co...&#34;

attributes                      BINARY    Z   _     98787     644.20 B           

hit_strategy_info               BINARY    Z   _     98787     0.00 B             

action_id                       INT32     Z _ R     98787     0.05 B     0       &#34;0&#34; / &#34;5&#34;

error_code                      INT32     Z _ R     98787     0.00 B     0       &#34;0&#34; / &#34;0&#34;

response_extra_info             BINARY    Z _ R     98787     0.04 B     0       &#34;{&#34;challenge_type&#34;:1,&#34;capt...&#34; / &#34;{}&#34;

event_id                        INT32     Z _ R     98787     0.27 B     0       &#34;0&#34; / &#34;9714&#34;

event_name                      BINARY    Z _ R     98787     0.08 B     93108   &#34;discovery_landing&#34; / &#34;search_event&#34;

source_system_name              BINARY    Z _ R     98787     0.00 B     0       &#34;anti_crawler&#34; / &#34;anti_crawler&#34;

event_local_datetime            BINARY    Z _ R_ F  98787     4.18 B     0       &#34;2023-03-22 00:00:00&#34; / &#34;2023-03-22 23:59:51&#34;

event_regional_datetime         BINARY    Z _ R_ F  98787     4.18 B     0       &#34;2023-03-22 00:00:00&#34; / &#34;2023-03-22 23:59:51&#34;

load_datetime                   BINARY    Z _ R     98787     0.00 B     0       &#34;2023-03-23 02:02:35.237&#34; / &#34;2023-03-23 02:02:35.237&#34;

is_strategy_hit                 INT32     Z _ R     98787     0.07 B     0       &#34;0&#34; / &#34;1&#34;

platform_desc                   BINARY    Z _ R     98787     0.27 B     0       &#34;android_app&#34; / &#34;unknown&#34;

action_type_desc                BINARY    Z _ R     98787     0.05 B     616     &#34;allow&#34; / &#34;force_login&#34;

is_ip_proxy                     BOOLEAN   Z   _     98787     0.09 B     89739   &#34;false&#34; / &#34;true&#34;

cookie                          BINARY    Z _ R_ F  98787     93.63 B    0       &#34;&#34; / &#34;{}&#34;

cookie_length                   INT32     Z _ R     98787     0.67 B     0       &#34;0&#34; / &#34;4305&#34;

ip_type_id                      INT32     Z _ R     98787     0.03 B     0       &#34;0&#34; / &#34;2&#34;

tls_fp_type_id                  INT32     Z _ R     98787     0.22 B     0       &#34;0&#34; / &#34;5&#34;

tls_fp_md5_hash                 BINARY    Z _ R     98787     1.79 B     0       &#34;&#34; / &#34;fffcc29122e024fe3cb419afc...&#34;

hit_strategy_info_v2            BINARY    Z _ R_ F  98787     2.01 B     0       &#34;[]&#34; / &#34;[{&#34;strategy_id&#34;:971400000...&#34;

waf_event_id                    INT64     Z _ R     98787     0.20 B     0       &#34;0&#34; / &#34;9716&#34;

tss_hit_module                  INT32     Z _ R     98787     0.06 B     0       &#34;0&#34; / &#34;3&#34;

tss_hit_module_desc             BINARY    Z _ R     98787     0.06 B     0       &#34;anti_crawler&#34; / &#34;waf&#34;

domain                          BINARY    Z _ R     98787     0.31 B     0       &#34;ats.workatsea.com&#34; / &#34;wfm.ssc.shopee.com&#34;

api_path                        BINARY    Z _ R     98787     1.34 B     0       &#34;/&#34; / &#34;/zenkosuperfoods&#34;

http_method                     BINARY    Z _ R     98787     0.18 B     0       &#34;GET&#34; / &#34;PUT&#34;

content_length                  BINARY    Z   _     98787     0.00 B             

ua_type_id                      INT32     Z   _     98787     0.00 B     98787   

device_id                       BINARY    Z _ R     98787     0.24 B     96651   &#34;1399998037467459258&#34; / &#34;4444444444444444444&#34;

tls_fp                          BINARY    Z _ R     98787     2.12 B     0       &#34;&#34; / &#34;771,61-53-49192-49191-491...&#34;

request_header                  BINARY    Z _ R_ F  98787     80.99 B    0       &#34;{&#34;1&#34;:&#34;Content-Type:applic...&#34; / &#34;{&#34;x-whs-id&#34;:&#34;TWYW&#34;,&#34;accep...&#34;

request_body                    BINARY    Z _ R_ F  98787     31.43 B    0       &#34;&#34; / &#34;{}&#34;

session_id                      BINARY    Z   _     98787     0.00 B             

sap                             BINARY    Z _ R_ F  98787     9.67 B     0       &#34;{&#34;method&#34;:&#34;GET&#34;,&#34;region&#34;:...&#34; / &#34;{&#34;signature&#34;:&#34;zpyBEkC0Q5-...&#34;

encrypted_security_data         BINARY    Z _ R_ F  98787     26.68 B    83402   &#34;&#34; / &#34;y&#34;

dfp_token                       BINARY    Z   _     98787     0.00 B             

ac_hit_strategy_ids             BINARY    Z _ R     98787     1.42 B     0       &#34;GET_ats.workatsea.com_/at...&#34; / &#34;PUT_help.shopee.sg_/api/i...&#34;

query                           BINARY    Z _ R_ F  98787     45.23 B    0       &#34;&#34; / &#34;zarsrc=31&amp;utm_source=zalo...&#34;

query_pair                      BINARY    Z _ R_ F  98787     48.70 B    0       &#34;{&#34;CSRF_TOKEN&#34;:&#34;b910ca37-e...&#34; / &#34;{}&#34;

hit_strategy_ids.list.element   INT64     Z _ R     110597    0.25 B     92280   &#34;7000&#34; / &#34;97140000003&#34;

ip_info                         BINARY    Z   _     98787     35.50 B    0       &#34;{&#34;asn&#34;:&#34;-&#34;,&#34;city&#34;:&#34;-&#34;,&#34;is...&#34; / &#34;{&#34;usagetype&#34;:&#34;SES&#34;,&#34;threa...&#34;

android_sdk_env_info            BINARY    Z   _     98787     8.25 B     93520   &#34;{&#34;android_checksum_check&#34;...&#34; / &#34;{&#34;wifi_ssid&#34;:&#34;\&#34;rayerayeo...&#34;

ios_sdk_env_info                BINARY    Z   _     98787     3.71 B     95001   &#34;{&#34;api_hooked_info&#34;:&#34;&#34;,&#34;ba...&#34; / &#34;{&#34;wifi_ssid&#34;:&#34;&#34;,&#34;wifi_ip_...&#34;

web_sdk_env_info                BINARY    Z _ R_ F  98787     4.63 B     96057   &#34;{&#34;audio_index&#34;:&#34;&#34;,&#34;beauti...&#34; / &#34;{&#34;window_top_position&#34;:84...&#34;

client_id                       BINARY    Z _ R     98787     0.06 B     93975   &#34;&#34; / &#34;&#34;

is_support_captcha              BOOLEAN   Z   _     98787     0.08 B     92209   &#34;false&#34; / &#34;true&#34;

experimental_event_id           INT64     Z _ R     98787     0.00 B     0       &#34;0&#34; / &#34;0&#34;

experimental_waf_event_id       INT64     Z _ R     98787     0.00 B     0       &#34;0&#34; / &#34;0&#34;

experimental_hit_strategy_info  BINARY    Z _ R     98787     0.00 B     0       &#34;[]&#34; / &#34;[]&#34;

tss_experimental_hit_module     INT32     Z   _     98787     0.00 B     98787   

Row group 1:  count: 95636  1.078 kB records  start: 114006788  total(compressed): 100.690 MB total(uncompressed):100.690 MB 

--------------------------------------------------------------------------------

                                type      encodings count     avg size   nulls   min / max

request_id                      BINARY    Z   _     95636     20.58 B    0       &#34;0002b378-c388-42bd-acd2-9...&#34; / &#34;fffc9037-04d4-4da6-890c-3...&#34;

event_timestamp                 INT64     Z _ R     95636     3.37 B     0       &#34;1679414401&#34; / &#34;1679500798&#34;

user_id                         INT64     Z   _     95636     0.67 B     83711   &#34;11742&#34; / &#34;973157000&#34;

shopee_df_plain                 BINARY    Z _ R     95636     4.72 B     74195   &#34;&#34; / &#34;zzgSI7P7xIljQVmv2JAR7B03a...&#34;

client_ip                       BINARY    Z _ R     95636     2.82 B     0       &#34;1.10.202.98&#34; / &#34;99.246.22.202&#34;

ip_country                      BINARY    Z _ R     95636     0.45 B     0       &#34;&#34; / &#34;ZA&#34;

domain_country                  BINARY    Z _ R     95636     0.00 B     0       &#34;SG&#34; / &#34;SG&#34;

referer                         BINARY    Z _ R_ F  95636     12.25 B    0       &#34;&#34; / &#34;https://zimpolo.com/&#34;

user_agent                      BINARY    Z _ R_ F  95636     3.96 B     0       &#34;&#34; / &#34;unirest-php/2.0&#34;

platform_id                     INT32     Z _ R     95636     0.27 B     0       &#34;0&#34; / &#34;8&#34;

client_url                      BINARY    Z _ R_ F  95636     52.20 B    0       &#34;http://c-api-subaccount.s...&#34; / &#34;https://wfm.ssc.shopee.co...&#34;

attributes                      BINARY    Z   _     95636     617.98 B           

hit_strategy_info               BINARY    Z   _     95636     0.00 B             

action_id                       INT32     Z _ R     95636     0.05 B     0       &#34;0&#34; / &#34;5&#34;

error_code                      INT32     Z _ R     95636     0.00 B     0       &#34;0&#34; / &#34;0&#34;

response_extra_info             BINARY    Z _ R     95636     0.04 B     0       &#34;{&#34;challenge_type&#34;:1,&#34;capt...&#34; / &#34;{}&#34;

event_id                        INT32     Z _ R     95636     0.26 B     0       &#34;0&#34; / &#34;9714&#34;

event_name                      BINARY    Z _ R     95636     0.08 B     90601   &#34;discovery_landing&#34; / &#34;spx_event&#34;

source_system_name              BINARY    Z _ R     95636     0.00 B     0       &#34;anti_crawler&#34; / &#34;anti_crawler&#34;

event_local_datetime            BINARY    Z _ R_ F  95636     4.10 B     0       &#34;2023-03-22 00:00:01&#34; / &#34;2023-03-22 23:59:58&#34;

event_regional_datetime         BINARY    Z _ R_ F  95636     4.10 B     0       &#34;2023-03-22 00:00:01&#34; / &#34;2023-03-22 23:59:58&#34;

load_datetime                   BINARY    Z _ R     95636     0.00 B     0       &#34;2023-03-23 02:02:35.237&#34; / &#34;2023-03-23 02:02:35.237&#34;

is_strategy_hit                 INT32     Z _ R     95636     0.07 B     0       &#34;0&#34; / &#34;1&#34;

platform_desc                   BINARY    Z _ R     95636     0.27 B     0       &#34;android_app&#34; / &#34;unknown&#34;

action_type_desc                BINARY    Z _ R     95636     0.05 B     560     &#34;allow&#34; / &#34;force_login&#34;

is_ip_proxy                     BOOLEAN   Z   _     95636     0.08 B     88200   &#34;false&#34; / &#34;true&#34;

cookie                          BINARY    Z _ R_ F  95636     79.81 B    0       &#34;&#34; / &#34;{}&#34;

cookie_length                   INT32     Z _ R     95636     0.63 B     0       &#34;0&#34; / &#34;3688&#34;

ip_type_id                      INT32     Z _ R     95636     0.03 B     0       &#34;0&#34; / &#34;2&#34;

tls_fp_type_id                  INT32     Z _ R     95636     0.23 B     0       &#34;0&#34; / &#34;5&#34;

tls_fp_md5_hash                 BINARY    Z _ R     95636     1.70 B     0       &#34;&#34; / &#34;fffd2ec209e0d89e606cbb061...&#34;

hit_strategy_info_v2            BINARY    Z _ R_ F  95636     1.93 B     0       &#34;[]&#34; / &#34;[{&#34;strategy_id&#34;:971400000...&#34;

waf_event_id                    INT64     Z _ R     95636     0.20 B     0       &#34;0&#34; / &#34;9716&#34;

tss_hit_module                  INT32     Z _ R     95636     0.06 B     0       &#34;0&#34; / &#34;3&#34;

tss_hit_module_desc             BINARY    Z _ R     95636     0.06 B     0       &#34;anti_crawler&#34; / &#34;waf&#34;

domain                          BINARY    Z _ R     95636     0.29 B     0       &#34;ats.workatsea.com&#34; / &#34;wfm.ssc.shopee.com&#34;

api_path                        BINARY    Z _ R     95636     1.33 B     0       &#34;/&#34; / &#34;/zenkosuperfoods&#34;

http_method                     BINARY    Z _ R     95636     0.18 B     0       &#34;GET&#34; / &#34;PUT&#34;

content_length                  BINARY    Z   _     95636     0.00 B             

ua_type_id                      INT32     Z   _     95636     0.00 B     95636   

device_id                       BINARY    Z _ R     95636     0.21 B     93875   &#34;1399683719822439175&#34; / &#34;1638570858845819429&#34;

tls_fp                          BINARY    Z _ R     95636     2.05 B     0       &#34;&#34; / &#34;771,61-53-49192-49191-491...&#34;

request_header                  BINARY    Z _ R_ F  95636     76.18 B    0       &#34;{&#34;0&#34;:&#34;Accept:*/*&#34;,&#34;host&#34;:...&#34; / &#34;{&#34;x-whs-id&#34;:&#34;TWYW&#34;,&#34;conte...&#34;

request_body                    BINARY    Z _ R_ F  95636     30.45 B    0       &#34;&#34; / &#34;{}&#34;

session_id                      BINARY    Z   _     95636     0.00 B             

sap                             BINARY    Z _ R_ F  95636     8.72 B     0       &#34;{&#34;method&#34;:&#34;GET&#34;,&#34;region&#34;:...&#34; / &#34;{&#34;signature&#34;:&#34;zxkNMfBsS28...&#34;

encrypted_security_data         BINARY    Z _ R_ F  95636     22.94 B    82594   &#34;&#34; / &#34;z&#34;

dfp_token                       BINARY    Z   _     95636     0.00 B             

ac_hit_strategy_ids             BINARY    Z _ R     95636     1.40 B     0       &#34;GET_ats.workatsea.com_/at...&#34; / &#34;PUT_help.shopee.sg_/api/i...&#34;

query                           BINARY    Z _ R_ F  95636     46.50 B    0       &#34;&#34; / &#34;zarsrc=31&amp;utm_source=zalo...&#34;

query_pair                      BINARY    Z _ R_ F  95636     49.92 B    0       &#34;{&#34;CSRF_TOKEN&#34;:&#34;47f3be6f-4...&#34; / &#34;{}&#34;

hit_strategy_ids.list.element   INT64     Z _ R     106654    0.24 B     89741   &#34;7000&#34; / &#34;97140000003&#34;

ip_info                         BINARY    Z   _     95636     35.36 B    0       &#34;{&#34;asn&#34;:&#34;-&#34;,&#34;city&#34;:&#34;-&#34;,&#34;do...&#34; / &#34;{&#34;usagetype&#34;:&#34;SES&#34;,&#34;threa...&#34;

android_sdk_env_info            BINARY    Z   _     95636     7.02 B     91310   &#34;{&#34;android_checksum_check&#34;...&#34; / &#34;{&#34;wifi_ssid&#34;:&#34;\&#34;winter so...&#34;

ios_sdk_env_info                BINARY    Z   _     95636     3.22 B     92519   &#34;{&#34;api_hooked_info&#34;:&#34;&#34;,&#34;ba...&#34; / &#34;{&#34;wifi_ssid&#34;:&#34;&#34;,&#34;wifi_ip_...&#34;

web_sdk_env_info                BINARY    Z _ R_ F  95636     4.76 B     92982   &#34;{&#34;audio_index&#34;:&#34;&#34;,&#34;batter...&#34; / &#34;{&#34;window_top_position&#34;:84...&#34;

client_id                       BINARY    Z _ R     95636     0.06 B     91471   &#34;&#34; / &#34;&#34;

is_support_captcha              BOOLEAN   Z   _     95636     0.08 B     89801   &#34;false&#34; / &#34;true&#34;

experimental_event_id           INT64     Z _ R     95636     0.00 B     0       &#34;0&#34; / &#34;0&#34;

experimental_waf_event_id       INT64     Z _ R     95636     0.00 B     0       &#34;0&#34; / &#34;0&#34;

experimental_hit_strategy_info  BINARY    Z _ R     95636     0.00 B     0       &#34;[]&#34; / &#34;[]&#34;

tss_experimental_hit_module     INT32     Z   _     95636     0.00 B     95636  
</code></pre><p>Encodings
([_SGLB$Z?])\s([<em>RD?\s])?\s(R)?(</em>)?(D)?(\sF)?</p>
<p>First group, compression codec
_ = uncompressed
S = snappy
G = gzip
L = LZ0
B = Brotli
4 = LZ4
Z = ZSTD
? = unknown
Second group, enum of dictionary encoding
_ = plain
R= RLE
D = delta byte array
? = unknown
\s =  no dictionary
Third group, whether encodings has RLE
R = data encodings has RLE
Forth group, whether data encodings has plain
_ = data encodings has plain
Fifth group, whether data encodings has delta
D =  data encodings has delta
Sixth group, whether data has fallback
\sF = data has fallback
In our example, we can understand it as follows:
Z   _ = ZSTD compressed, no dictionary, data encoded in plain, example: request_id
Z _ R = ZSTD compressed, data encoded in plain dictionary, but data is RLE example: event_timestamp
Z _ R_ F  = ZSTD compressed, dictionary encoded in plain, data encoded in RLE and plain, there is a fallback, example: referer, user_agent
Key takeaways
Theory - theory of parquet is useful not just for knowledge&rsquo;s sake but is widely used in systems such as Spark, Hudi and Flink. Even new data formats such as delta and arrow are inspired by parquet. Understanding parquet helps to understand the more complicated systems and data formats, and hopefully lets you design better systems
Query - parquet stores the columns separately, so by querying only columns we need, we can speed up the queries by only reading the related column chunks
Schema design - if you map the schema directly to parquet types, you can save the key for space and also use more efficient data types and encodings. So its definitely more space efficient to store the schema as detailed as it can be, instead of using a big string JSON field for example
Data colocation - due to the RLE/bitpack encoding method used in parquet, if we skew the data, we can efficiently store it. So if we put the same data in the same parquet file, we can save a lot of storage space, in fact, there is an ongoing effort by our team to improve the storage space usage using this method</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/parquet/">Parquet</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/data-format/avro/">
    <span class="title">« Prev</span>
    <br>
    <span>Avro</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on x"
            href="https://x.com/intent/tweet/?text=Parquet&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f&amp;hashtags=Parquet">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f&amp;title=Parquet&amp;summary=Parquet&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f&title=Parquet">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on whatsapp"
            href="https://api.whatsapp.com/send?text=Parquet%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on telegram"
            href="https://telegram.me/share/url?text=Parquet&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Parquet on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Parquet&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fdata-format%2fparquet%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">lumotheninja</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
